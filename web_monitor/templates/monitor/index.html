<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAO教学系统监控平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io/client-dist/socket.io.js"></script>
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .log-entry:hover {
            background-color: #f5f5f5;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-connected {
            background-color: #28a745;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .emotion-pill {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            margin-right: 5px;
        }
        .emotion-喜悦 { background-color: #28a745; }
        .emotion-悲伤 { background-color: #6c757d; }
        .emotion-愤怒 { background-color: #dc3545; }
        .emotion-恐惧 { background-color: #6610f2; }
        .emotion-惊讶 { background-color: #fd7e14; }
        .emotion-厌恶 { background-color: #6f42c1; }
        .emotion-中性 { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">NAO教学系统监控平台</h1>

        <!-- 状态和控制栏 -->
        <div class="card">
            <div class="card-header">
                系统状态 &amp; 控制
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <span class="status-indicator" id="connection-status"></span>
                            <span id="connection-text">未连接</span>
                        </div>
                        <div id="last-update-time"></div>
                    </div>
                    <div class="col-md-5">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="server-url" placeholder="WS服务器地址" value="ws://localhost:8765">
                            <button class="btn btn-primary" id="connect-btn">连接</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success" id="save-data-btn">保存数据</button>
                        <button class="btn btn-secondary" id="clear-data-btn">清除数据</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 会话信息 -->
        <div class="card">
            <div class="card-header">
                当前会话
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <p><strong>会话ID:</strong> <span id="session-id">未知</span></p>
                        <p><strong>开始时间:</strong> <span id="session-start-time">未知</span></p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>当前概念:</strong> <span id="current-concept">未知</span></p>
                        <p><strong>学生情绪:</strong> <span id="student-emotion" class="emotion-pill">未知</span></p>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="text-input" placeholder="发送文本...">
                            <button class="btn btn-primary" id="send-text-btn">发送</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        情感状态跟踪
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="emotion-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        学习状态跟踪
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="learning-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日志区域 -->
        <div class="card">
            <div class="card-header">
                系统日志
            </div>
            <div class="card-body">
                <div class="log-container" id="log-container">
                    <!-- 日志内容将通过JavaScript动态添加 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始化SocketIO连接
        const socket = io();

        // 图表对象
        let emotionChart;
        let learningChart;

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化图表
            initCharts();

            // 获取初始数据
            fetchInitialData();

            // 绑定按钮事件
            document.getElementById('connect-btn').addEventListener('click', connectToServer);
            document.getElementById('save-data-btn').addEventListener('click', saveData);
            document.getElementById('clear-data-btn').addEventListener('click', clearData);
            document.getElementById('send-text-btn').addEventListener('click', sendText);
            document.getElementById('text-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendText();
                }
            });

            // 监听Socket.IO事件
            socket.on('server_status', updateServerStatus);
            socket.on('update_charts', updateCharts);
            socket.on('new_message', addNewMessage);
        });

        // 初始化图表
        function initCharts() {
            // 情感图表
            const emotionCtx = document.getElementById('emotion-chart').getContext('2d');
            emotionChart = new Chart(emotionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '喜悦',
                            data: [],
                            borderColor: 'rgba(40, 167, 69, 1)',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: '悲伤',
                            data: [],
                            borderColor: 'rgba(108, 117, 125, 1)',
                            backgroundColor: 'rgba(108, 117, 125, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: '愤怒',
                            data: [],
                            borderColor: 'rgba(220, 53, 69, 1)',
                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: '恐惧',
                            data: [],
                            borderColor: 'rgba(102, 16, 242, 1)',
                            backgroundColor: 'rgba(102, 16, 242, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: '惊讶',
                            data: [],
                            borderColor: 'rgba(253, 126, 20, 1)',
                            backgroundColor: 'rgba(253, 126, 20, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: '厌恶',
                            data: [],
                            borderColor: 'rgba(111, 66, 193, 1)',
                            backgroundColor: 'rgba(111, 66, 193, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: '中性',
                            data: [],
                            borderColor: 'rgba(23, 162, 184, 1)',
                            backgroundColor: 'rgba(23, 162, 184, 0.2)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });

            // 学习状态图表
            const learningCtx = document.getElementById('learning-chart').getContext('2d');
            learningChart = new Chart(learningCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '注意力',
                            data: [],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: '参与度',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: '理解度',
                            data: [],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }

        // 获取初始数据
        function fetchInitialData() {
            // 获取系统状态
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateStatusDisplay(data);
                })
                .catch(error => console.error('获取系统状态失败:', error));

            // 获取情感数据
            fetch('/api/emotion_data')
                .then(response => response.json())
                .then(data => {
                    updateEmotionChart(data);
                })
                .catch(error => console.error('获取情感数据失败:', error));

            // 获取学习状态数据
            fetch('/api/learning_data')
                .then(response => response.json())
                .then(data => {
                    updateLearningChart(data);
                })
                .catch(error => console.error('获取学习状态数据失败:', error));

            // 获取日志数据
            fetch('/api/logs')
                .then(response => response.json())
                .then(data => {
                    updateLogs(data);
                })
                .catch(error => console.error('获取日志数据失败:', error));

            // 获取会话信息
            fetch('/api/session')
                .then(response => response.json())
                .then(data => {
                    updateSessionInfo(data);
                })
                .catch(error => console.error('获取会话信息失败:', error));
        }

        // 更新状态显示
        function updateStatusDisplay(data) {
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            const lastUpdateTime = document.getElementById('last-update-time');

            if (data.connected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.innerText = '已连接';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.innerText = '未连接';
            }

            if (data.last_update) {
                lastUpdateTime.innerText = `最后更新: ${data.last_update}`;
            }

            document.getElementById('server-url').value = data.server_url;
        }

        // 更新情感图表
        function updateEmotionChart(data) {
            emotionChart.data.labels = data.labels;

            data.datasets.forEach((dataset, index) => {
                if (index < emotionChart.data.datasets.length) {
                    emotionChart.data.datasets[index].data = dataset.data;
                }
            });

            emotionChart.update();
        }

        // 更新学习状态图表
        function updateLearningChart(data) {
            learningChart.data.labels = data.labels;

            data.datasets.forEach((dataset, index) => {
                if (index < learningChart.data.datasets.length) {
                    learningChart.data.datasets[index].data = dataset.data;
                }
            });

            learningChart.update();
        }

        // 更新日志
        function updateLogs(logs) {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = ''; // 清空现有日志

            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <small class="text-muted">${log.timestamp}</small>
                    <span class="badge bg-info">${log.type}</span>
                    <span>${getLogContent(log)}</span>
                `;
                logContainer.appendChild(logEntry);
            });
        }

        // 获取日志内容的简短描述
        function getLogContent(log) {
            if (log.type === 'text_result') {
                return `文本响应: ${log.data.data.text.substring(0, 50)}...`;
            } else if (log.type === 'audio_result' || log.type === 'image_result') {
                const emotion = log.data.data.emotion;
                return `情感分析: ${emotion}`;
            } else if (log.type === 'error') {
                return `错误: ${log.data.message}`;
            } else {
                return `${log.type} 消息`;
            }
        }

        // 更新会话信息
        function updateSessionInfo(data) {
            const sessionId = document.getElementById('session-id');
            const startTime = document.getElementById('session-start-time');
            const currentConcept = document.getElementById('current-concept');
            const studentEmotion = document.getElementById('student-emotion');

            sessionId.innerText = data.session_id || '未知';
            startTime.innerText = data.start_time || '未知';
            currentConcept.innerText = data.current_concept || '未知';

            if (data.student_emotion) {
                studentEmotion.innerText = data.student_emotion;
                studentEmotion.className = `emotion-pill emotion-${data.student_emotion}`;
            } else {
                studentEmotion.innerText = '未知';
                studentEmotion.className = 'emotion-pill';
            }
        }

        // 连接到服务器
        function connectToServer() {
            const serverUrl = document.getElementById('server-url').value;

            if (!serverUrl) {
                alert('请输入服务器地址！');
                return;
            }

            fetch('/api/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ server_url: serverUrl })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('连接成功');
                } else {
                    alert('连接失败！');
                }
            })
            .catch(error => {
                console.error('连接请求出错:', error);
                alert('连接请求出错！');
            });
        }

        // 保存数据
        function saveData() {
            const timestamp = new Date().toISOString().replace(/:/g, '-').substring(0, 19);
            const filename = `nao_monitor_data_${timestamp}.json`;

            fetch('/api/emotion_data')
                .then(response => response.json())
                .then(emotionData => {
                    fetch('/api/learning_data')
                        .then(response => response.json())
                        .then(learningData => {
                            fetch('/api/logs')
                                .then(response => response.json())
                                .then(logs => {
                                    // 创建保存数据
                                    const saveData = {
                                        timestamp: timestamp,
                                        emotion_data: emotionData,
                                        learning_data: learningData,
                                        logs: logs
                                    };

                                    // 创建下载链接
                                    const dataStr = JSON.stringify(saveData, null, 2);
                                    const blob = new Blob([dataStr], { type: 'application/json' });
                                    const url = URL.createObjectURL(blob);

                                    // 创建下载元素
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = filename;
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(url);
                                });
                        });
                });
        }

        // 清除数据
        function clearData() {
            if (confirm('确定要清除所有监控数据吗？')) {
                fetch('/api/clear_data', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('数据已清除！');
                        // 重新获取数据
                        fetchInitialData();
                    } else {
                        alert('清除数据失败！');
                    }
                })
                .catch(error => {
                    console.error('清除数据请求出错:', error);
                    alert('清除数据请求出错！');
                });
            }
        }

        // 发送文本
        function sendText() {
            const textInput = document.getElementById('text-input');
            const text = textInput.value.trim();

            if (!text) {
                return;
            }

            fetch('/api/send_text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 清空输入框
                    textInput.value = '';

                    // 添加到日志
                    const logContainer = document.getElementById('log-container');
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';

                    const timestamp = new Date().toTimeString().split(' ')[0];
                    logEntry.innerHTML = `
                        <small class="text-muted">${timestamp}</small>
                        <span class="badge bg-primary">发送</span>
                        <span>${text}</span>
                    `;

                    logContainer.insertBefore(logEntry, logContainer.firstChild);
                } else {
                    alert('发送失败！');
                }
            })
            .catch(error => {
                console.error('发送文本请求出错:', error);
                alert('发送文本请求出错！');
            });
        }

        // 更新服务器状态（Socket.IO事件处理）
        function updateServerStatus(data) {
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');

            if (data.connected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.innerText = '已连接';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.innerText = '未连接';
            }
        }

        // 更新图表（Socket.IO事件处理）
        function updateCharts() {
            // 获取情感数据
            fetch('/api/emotion_data')
                .then(response => response.json())
                .then(data => {
                    updateEmotionChart(data);
                })
                .catch(error => console.error('获取情感数据失败:', error));

            // 获取学习状态数据
            fetch('/api/learning_data')
                .then(response => response.json())
                .then(data => {
                    updateLearningChart(data);
                })
                .catch(error => console.error('获取学习状态数据失败:', error));

            // 获取会话信息
            fetch('/api/session')
                .then(response => response.json())
                .then(data => {
                    updateSessionInfo(data);
                })
                .catch(error => console.error('获取会话信息失败:', error));
        }

        // 添加新消息（Socket.IO事件处理）
        function addNewMessage(data) {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            const timestamp = new Date().toTimeString().split(' ')[0];
            logEntry.innerHTML = `
                <small class="text-muted">${timestamp}</small>
                <span class="badge bg-info">${data.type}</span>
                <span>${data.content}</span>
            `;

            logContainer.insertBefore(logEntry, logContainer.firstChild);
        }
    </script>
</body>
</html>