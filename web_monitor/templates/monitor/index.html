<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAO教学系统监控</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-header { font-weight: bold; border-bottom: 1px solid rgba(0,0,0,0.125); }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .log-container { height: 300px; overflow-y: auto; }
        .log-entry { padding: 8px; border-bottom: 1px solid #f0f0f0; }
        .chart-container { height: 300px; position: relative; }
        .emotion-tag { display: inline-block; padding: 2px 8px; border-radius: 12px; color: white; font-size: 0.9em; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">NAO教学系统监控</h1>

        <!-- 状态卡片 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">系统状态</div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="status-indicator" id="status-indicator"></span>
                                <span id="status-text">未连接</span>
                            </div>
                            <div>
                                <span id="last-update"></span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="server-url" placeholder="服务器地址">
                                <button class="btn btn-primary" id="connect-btn">连接</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">会话信息</div>
                    <div class="card-body">
                        <div>
                            <strong>会话ID:</strong> <span id="session-id">无</span>
                        </div>
                        <div>
                            <strong>开始时间:</strong> <span id="session-start">无</span>
                        </div>
                        <div>
                            <strong>当前概念:</strong> <span id="current-concept">无</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 交互卡片 -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">发送消息</div>
                    <div class="card-body">
                        <div class="input-group">
                            <input type="text" class="form-control" id="message-input" placeholder="输入消息...">
                            <button class="btn btn-success" id="send-btn">发送</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表卡片 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">情感状态</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="emotion-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">学习状态</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="learning-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日志卡片 -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>系统日志</span>
                        <div>
                            <button class="btn btn-sm btn-secondary" id="clear-btn">清除</button>
                            <button class="btn btn-sm btn-primary" id="save-btn">保存</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="log-container" id="log-container">
                            <!-- 日志内容将通过JavaScript动态添加 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 全局变量
        let emotionChart = null;
        let learningChart = null;

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化图表
            initCharts();

            // 绑定按钮事件
            document.getElementById('connect-btn').addEventListener('click', connectToServer);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('clear-btn').addEventListener('click', clearData);
            document.getElementById('save-btn').addEventListener('click', saveData);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // 加载初始数据
            loadStatus();
            loadSession();
            loadLogs();
            loadEmotionData();
            loadLearningData();

            // 定时刷新数据
            setInterval(function() {
                loadStatus();
                loadSession();
                loadLogs();
                loadEmotionData();
                loadLearningData();
            }, 2000);
        });

        // 初始化图表
        function initCharts() {
            // 初始化情感图表
            const emotionCtx = document.getElementById('emotion-chart').getContext('2d');
            emotionChart = new Chart(emotionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });

            // 初始化学习状态图表
            const learningCtx = document.getElementById('learning-chart').getContext('2d');
            learningChart = new Chart(learningCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '注意力',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '参与度',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '理解度',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }

        // 连接到服务器
        function connectToServer() {
            const serverUrl = document.getElementById('server-url').value;
            if (!serverUrl) {
                alert('请输入服务器地址');
                return;
            }

            fetch('/api/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ server_url: serverUrl })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStatus({ connected: true, server_url: serverUrl, last_update: new Date().toLocaleString() });
                } else {
                    alert('连接失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('连接请求出错:', error);
                alert('连接请求出错');
            });
        }

        // 发送消息
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const text = messageInput.value.trim();

            if (!text) {
                return;
            }

            fetch('/api/send_text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageInput.value = '';
                } else {
                    alert('发送消息失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('发送消息请求出错:', error);
                alert('发送消息请求出错');
            });
        }

        // 清除数据
        function clearData() {
            if (!confirm('确定要清除所有数据吗？')) {
                return;
            }

            fetch('/api/clear', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 清除图表数据
                    clearCharts();

                    // 清除日志
                    document.getElementById('log-container').innerHTML = '';
                } else {
                    alert('清除数据失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('清除数据请求出错:', error);
                alert('清除数据请求出错');
            });
        }

        // 保存数据
        function saveData() {
            fetch('/api/save', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('数据已保存: ' + data.filename);
                } else {
                    alert('保存数据失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('保存数据请求出错:', error);
                alert('保存数据请求出错');
            });
        }

        // 清除图表数据
        function clearCharts() {
            // 清除情感图表
            emotionChart.data.labels = [];
            emotionChart.data.datasets = [];
            emotionChart.update();

            // 清除学习状态图表
            learningChart.data.labels = [];
            learningChart.data.datasets.forEach(dataset => {
                dataset.data = [];
            });
            learningChart.update();
        }

        // 加载系统状态
        function loadStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateStatus(data);
                })
                .catch(error => {
                    console.error('获取状态失败:', error);
                });
        }

        // 更新状态显示
        function updateStatus(data) {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const lastUpdate = document.getElementById('last-update');
            const serverUrlInput = document.getElementById('server-url');

            if (data.connected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = '已连接';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = '未连接';
            }

            lastUpdate.textContent = '最后更新: ' + data.last_update;

            if (data.server_url) {
                serverUrlInput.value = data.server_url;
            }
        }

        // 加载会话信息
        function loadSession() {
            fetch('/api/session')
                .then(response => response.json())
                .then(data => {
                    updateSession(data);
                })
                .catch(error => {
                    console.error('获取会话信息失败:', error);
                });
        }

        // 更新会话信息显示
        function updateSession(data) {
            const sessionId = document.getElementById('session-id');
            const sessionStart = document.getElementById('session-start');
            const currentConcept = document.getElementById('current-concept');

            sessionId.textContent = data.session_id || '无';
            sessionStart.textContent = data.start_time || '无';
            currentConcept.textContent = data.current_concept || '无';
        }

        // 加载日志
        function loadLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(data => {
                    updateLogs(data);
                })
                .catch(error => {
                    console.error('获取日志失败:', error);
                });
        }

        // 更新日志显示
        function updateLogs(logs) {
            const logContainer = document.getElementById('log-container');

            // 清空日志容器
            logContainer.innerHTML = '';

            // 添加日志条目
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';

                // 根据日志类型设置样式
                let typeClass = '';
                let displayType = log.type;

                switch (log.type) {
                    case 'error':
                        typeClass = 'text-danger';
                        break;
                    case 'system':
                        typeClass = 'text-primary';
                        break;
                    case 'text_result':
                        typeClass = 'text-success';
                        displayType = 'AI回答';
                        break;
                    case 'user_query':
                        typeClass = 'text-info';
                        displayType = '用户问题';
                        break;
                    default:
                        typeClass = 'text-secondary';
                }

                // 格式化日志内容
                let content = log.message;
                if (typeof content === 'object') {
                    try {
                        content = JSON.stringify(content);
                    } catch (e) {
                        content = '[复杂对象]';
                    }
                }

                logEntry.innerHTML = `
                    <span class="text-muted">${log.timestamp}</span>
                    <span class="${typeClass}">[${log.type}]</span>
                    <span>${content}</span>
                `;

                logContainer.appendChild(logEntry);
            });
        }

        // 加载情感数据
        function loadEmotionData() {
            fetch('/api/emotion_data')
                .then(response => response.json())
                .then(data => {
                    updateEmotionChart(data);
                })
                .catch(error => {
                    console.error('获取情感数据失败:', error);
                });
        }

        // 更新情感图表
        function updateEmotionChart(data) {
            // 获取情感数据
            const timestamps = data.timestamps || [];
            const emotions = data.emotions || {};

            // 更新图表数据
            emotionChart.data.labels = timestamps;

            // 清除现有数据集
            emotionChart.data.datasets = [];

            // 为每种情感创建数据集
            const emotionColors = {
                '喜悦': 'rgb(40, 167, 69)',
                '悲伤': 'rgb(108, 117, 125)',
                '愤怒': 'rgb(220, 53, 69)',
                '恐惧': 'rgb(102, 16, 242)',
                '惊讶': 'rgb(253, 126, 20)',
                '厌恶': 'rgb(111, 66, 193)',
                '中性': 'rgb(23, 162, 184)',
                'happy': 'rgb(40, 167, 69)',
                'sad': 'rgb(108, 117, 125)',
                'angry': 'rgb(220, 53, 69)',
                'fear': 'rgb(102, 16, 242)',
                'surprise': 'rgb(253, 126, 20)',
                'disgust': 'rgb(111, 66, 193)',
                'neutral': 'rgb(23, 162, 184)'
            };

            for (const [emotion, values] of Object.entries(emotions)) {
                const color = emotionColors[emotion] || `hsl(${Math.random() * 360}, 70%, 50%)`;

                emotionChart.data.datasets.push({
                    label: emotion,
                    data: values,
                    borderColor: color,
                    backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    tension: 0.1
                });
            }

            // 更新图表
            emotionChart.update();
        }

        // 加载学习状态数据
        function loadLearningData() {
            fetch('/api/learning_data')
                .then(response => response.json())
                .then(data => {
                    updateLearningChart(data);
                })
                .catch(error => {
                    console.error('获取学习状态数据失败:', error);
                });
        }

        // 更新学习状态图表
        function updateLearningChart(data) {
            // 获取学习状态数据
            const timestamps = data.timestamps || [];
            const attention = data.attention || [];
            const engagement = data.engagement || [];
            const understanding = data.understanding || [];

            // 更新图表数据
            learningChart.data.labels = timestamps;
            learningChart.data.datasets[0].data = attention;
            learningChart.data.datasets[1].data = engagement;
            learningChart.data.datasets[2].data = understanding;

            // 更新图表
            learningChart.update();
        }
    </script>
</body>
</html>
