<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>NAO教学系统监控</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .card { border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .log-container { height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
    </style>
</head>
<body>
    <h1>NAO教学系统监控</h1>

    <div class="card">
        <h2>系统状态</h2>
        <div>
            <span class="status-indicator" id="connection-status"></span>
            <span id="connection-text">未连接</span>
        </div>
        <div class="connection-form">
            <input type="text" id="server-url" placeholder="WebSocket服务器地址" value="ws://localhost:8765">
            <button id="connect-btn">连接</button>
        </div>
    </div>

    <div class="card">
        <h2>系统日志</h2>
        <div class="log-container" id="log-container">
            <!-- 日志内容将通过JavaScript动态添加 -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // 初始化Socket.IO连接
        const socket = io();

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            const serverUrlInput = document.getElementById('server-url');
            const connectBtn = document.getElementById('connect-btn');
            const logContainer = document.getElementById('log-container');

            // 绑定连接按钮事件
            connectBtn.addEventListener('click', function() {
                const serverUrl = serverUrlInput.value;
                if (!serverUrl) return;

                fetch('/api/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ server_url: serverUrl })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('连接成功');
                    } else {
                        alert('连接失败!');
                    }
                })
                .catch(error => {
                    console.error('连接请求出错:', error);
                    alert('连接请求出错!');
                });
            });

            // 监听Socket.IO事件
            socket.on('update', function(data) {
                if (data.type === 'status') {
                    updateStatus(data.connected);
                } else if (data.type === 'log') {
                    loadLogs();
                }
            });

            // 加载初始状态
            loadStatus();
            loadLogs();

            // 函数: 加载状态
            function loadStatus() {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        updateStatus(data.connected);
                        serverUrlInput.value = data.server_url;
                    })
                    .catch(error => console.error('获取状态失败:', error));
            }

            // 函数: 更新状态显示
            function updateStatus(connected) {
                if (connected) {
                    statusIndicator.className = 'status-indicator status-connected';
                    statusText.innerText = '已连接';
                } else {
                    statusIndicator.className = 'status-indicator status-disconnected';
                    statusText.innerText = '未连接';
                }
            }

            // 函数: 加载日志
            function loadLogs() {
                fetch('/api/logs')
                    .then(response => response.json())
                    .then(logs => {
                        logContainer.innerHTML = '';

                        logs.forEach(log => {
                            const logEntry = document.createElement('div');
                            logEntry.className = 'log-entry';
                            logEntry.innerHTML = `
                                <span class="log-time">${log.timestamp}</span>
                                <span class="log-type">${log.type}</span>
                                <span class="log-content">${log.content}</span>
                            `;
                            logContainer.appendChild(logEntry);
                        });
                    })
                    .catch(error => console.error('获取日志失败:', error));
            }
        });
    </script>
</body>
</html>