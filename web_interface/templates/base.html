{% extends "base.html" %}

{% block title %}知识图谱 - NAO教学系统{% endblock %}

{% block extra_css %}
<style>
    #knowledge-graph {
        width: 100%;
        height: 600px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    
    .search-box {
        margin-bottom: 15px;
    }
    
    .concept-details {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-top: 15px;
        background-color: #f8f9fa;
    }
    
    .concept-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .concept-definition {
        margin-bottom: 15px;
    }
    
    .concept-meta {
        display: flex;
        margin-bottom: 15px;
    }
    
    .concept-meta-item {
        margin-right: 20px;
    }
    
    .concept-examples {
        margin-bottom: 15px;
    }
    
    .concept-examples-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .concept-example {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        margin-bottom: 5px;
    }
    
    .related-concepts {
        margin-bottom: 15px;
    }
    
    .related-concept {
        display: inline-block;
        padding: 5px 10px;
        background-color: #e2f3fd;
        color: #0d6efd;
        border-radius: 15px;
        margin-right: 5px;
        margin-bottom: 5px;
        cursor: pointer;
    }
    
    .related-concept:hover {
        background-color: #cfe2ff;
    }
    
    .domain-filter {
        margin-bottom: 15px;
    }
    
    .difficulty-badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        margin-right: 5px;
    }

    .difficulty-1 {
        background-color: #d1e7dd;
        color: #146c43;
    }

    .difficulty-2 {
        background-color: #d1e7dd;
        color: #146c43;
    }

    .difficulty-3 {
        background-color: #fff3cd;
        color: #997404;
    }

    .difficulty-4 {
        background-color: #f8d7da;
        color: #b02a37;
    }

    .difficulty-5 {
        background-color: #f8d7da;
        color: #b02a37;
    }

    .importance-badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }

    .importance-1 {
        background-color: #e2e3e5;
        color: #41464b;
    }

    .importance-2 {
        background-color: #e2e3e5;
        color: #41464b;
    }

    .importance-3 {
        background-color: #cff4fc;
        color: #055160;
    }

    .importance-4 {
        background-color: #cff4fc;
        color: #055160;
    }

    .importance-5 {
        background-color: #e2e3e5;
        color: #41464b;
        border: 2px solid #0d6efd;
    }
</style>
<!-- D3.js for visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Force-directed graph layout -->
<script src="https://unpkg.com/d3-force@3"></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="fas fa-project-diagram me-2"></i>知识图谱可视化</h2>
        <p class="text-muted">探索教学内容的知识结构和概念关系</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">筛选与搜索</h5>
            </div>
            <div class="card-body">
                <!-- Domain filter -->
                <div class="domain-filter">
                    <label for="domain-select" class="form-label">学科领域</label>
                    <select class="form-select" id="domain-select">
                        <option value="计算机科学" selected>计算机科学</option>
                        <option value="数学">数学</option>
                        <option value="物理学">物理学</option>
                        <option value="化学">化学</option>
                        <option value="生物学">生物学</option>
                        <option value="语言学">语言学</option>
                        <option value="心理学">心理学</option>
                        <option value="经济学">经济学</option>
                        <option value="哲学">哲学</option>
                        <option value="医学">医学</option>
                    </select>
                </div>

                <!-- Search box -->
                <div class="search-box">
                    <label for="concept-search" class="form-label">概念搜索</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="concept-search" placeholder="输入关键词...">
                        <button class="btn btn-primary" id="search-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="mb-3">
                    <label class="form-label">难度</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="1" id="difficulty-1" checked>
                        <label class="form-check-label" for="difficulty-1">
                            入门 <span class="difficulty-badge difficulty-1">1</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="2" id="difficulty-2" checked>
                        <label class="form-check-label" for="difficulty-2">
                            基础 <span class="difficulty-badge difficulty-2">2</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="3" id="difficulty-3" checked>
                        <label class="form-check-label" for="difficulty-3">
                            中级 <span class="difficulty-badge difficulty-3">3</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="4" id="difficulty-4" checked>
                        <label class="form-check-label" for="difficulty-4">
                            高级 <span class="difficulty-badge difficulty-4">4</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="5" id="difficulty-5" checked>
                        <label class="form-check-label" for="difficulty-5">
                            专家 <span class="difficulty-badge difficulty-5">5</span>
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">重要性</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="5" id="importance-5" checked>
                        <label class="form-check-label" for="importance-5">
                            核心 <span class="importance-badge importance-5">5</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="4" id="importance-4" checked>
                        <label class="form-check-label" for="importance-4">
                            重要 <span class="importance-badge importance-4">4</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="3" id="importance-3" checked>
                        <label class="form-check-label" for="importance-3">
                            一般 <span class="importance-badge importance-3">3</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="2" id="importance-2" checked>
                        <label class="form-check-label" for="importance-2">
                            次要 <span class="importance-badge importance-2">2</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="1" id="importance-1" checked>
                        <label class="form-check-label" for="importance-1">
                            补充 <span class="importance-badge importance-1">1</span>
                        </label>
                    </div>
                </div>

                <button class="btn btn-primary w-100" id="apply-filters">应用筛选</button>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">知识图谱</h5>
            </div>
            <div class="card-body">
                <div id="knowledge-graph"></div>
            </div>
        </div>

        <div id="concept-details-container" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">概念详情</h5>
                </div>
                <div class="card-body">
                    <div class="concept-details">
                        <div class="concept-title" id="concept-title">变量</div>

                        <div class="concept-meta">
                            <div class="concept-meta-item">
                                <strong>难度：</strong>
                                <span class="difficulty-badge difficulty-2" id="concept-difficulty">2</span>
                            </div>
                            <div class="concept-meta-item">
                                <strong>重要性：</strong>
                                <span class="importance-badge importance-5" id="concept-importance">5</span>
                            </div>
                        </div>

                        <div class="concept-definition" id="concept-definition">
                            变量是计算机内存中存储数据的命名空间。
                        </div>

                        <div class="concept-examples">
                            <div class="concept-examples-title">示例：</div>
                            <div id="concept-examples-list">
                                <div class="concept-example">int age = 18; // 声明一个整型变量并初始化为18</div>
                            </div>
                        </div>

                        <div class="related-concepts">
                            <div class="concept-examples-title">相关概念：</div>
                            <div id="related-concepts-list">
                                <span class="related-concept">常量</span>
                                <span class="related-concept">数据类型</span>
                                <span class="related-concept">作用域</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全局变量
    let graph = {
        nodes: [],
        links: []
    };
    let simulation;
    let svg;
    let currentDomain = "计算机科学";
    let filteredDifficulty = [1, 2, 3, 4, 5];
    let filteredImportance = [1, 2, 3, 4, 5];

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化图表
        initGraph();

        // 加载数据
        loadKnowledgeGraph();

        // 注册事件监听器
        registerEventListeners();
    });

    // 初始化图表
    function initGraph() {
        const container = document.getElementById('knowledge-graph');

        // 获取容器尺寸
        const width = container.clientWidth;
        const height = container.clientHeight;

        // 创建SVG
        svg = d3.select("#knowledge-graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(d3.zoom().on("zoom", function(event) {
                g.attr("transform", event.transform);
            }));

        // 创建主图层
        const g = svg.append("g");

        // 添加箭头定义
        svg.append("defs").selectAll("marker")
            .data(["end"])
            .enter().append("marker")
            .attr("id", "arrow")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 15)
            .attr("refY", -0.5)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("fill", "#999")
            .attr("d", "M0,-5L10,0L0,5");

        // 创建力导向图模拟
        simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(50));
    }

    // 加载知识图谱数据
    function loadKnowledgeGraph() {
        // 先获取概念
        fetch(`/api/knowledge/concepts?domain=${currentDomain}`)
            .then(response => response.json())
            .then(concepts => {
                // 转换为节点
                graph.nodes = concepts.map(concept => ({
                    id: concept.id,
                    name: concept.name,
                    difficulty: concept.difficulty,
                    importance: concept.importance
                }));

                // 获取关系
                return fetch(`/api/knowledge/relationships`);
            })
            .then(response => response.json())
            .then(relationships => {
                // 转换为连接
                graph.links = relationships.map(rel => ({
                    source: rel.source,
                    target: rel.target,
                    type: rel.type,
                    strength: rel.strength
                }));

                // 更新图表
                updateGraph();
            })
            .catch(error => console.error("获取知识图谱数据失败:", error));
    }

    // 更新图表
    function updateGraph() {
        // 清除原有内容
        d3.select("#knowledge-graph svg g").selectAll("*").remove();

        const g = d3.select("#knowledge-graph svg g");

        // 应用筛选
        const filteredNodes = graph.nodes.filter(node =>
            filteredDifficulty.includes(node.difficulty) &&
            filteredImportance.includes(node.importance)
        );

        // 只保留筛选节点之间的连接
        const filteredNodeIds = new Set(filteredNodes.map(node => node.id));
        const filteredLinks = graph.links.filter(link =>
            filteredNodeIds.has(link.source) && filteredNodeIds.has(link.target)
        );

        // 绘制连接
        const links = g.selectAll(".link")
            .data(filteredLinks)
            .enter().append("line")
            .attr("class", "link")
            .attr("stroke", "#999")
            .attr("stroke-opacity", 0.6)
            .attr("stroke-width", d => Math.sqrt(d.strength) * 2)
            .attr("marker-end", "url(#arrow)");

        // 绘制节点组
        const nodes = g.selectAll(".node")
            .data(filteredNodes)
            .enter().append("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on("click", showConceptDetails);

        // 节点圆形
        nodes.append("circle")
            .attr("r", d => 10 + d.importance * 2)
            .attr("fill", d => getNodeColor(d.difficulty))
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5);

        // 节点文本
        nodes.append("text")
            .attr("dy", 4)
            .attr("text-anchor", "middle")
            .text(d => d.name)
            .attr("fill", "#fff")
            .attr("font-size", "10px");

        // 更新模拟
        simulation
            .nodes(filteredNodes)
            .on("tick", ticked);

        simulation.force("link")
            .links(filteredLinks);

        // 重启模拟
        simulation.alpha(1).restart();

        // Tick函数，更新位置
        function ticked() {
            links
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            nodes.attr("transform", d => `translate(${d.x},${d.y})`);
        }

        // 拖拽功能
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }

    // 获取节点颜色
    function getNodeColor(difficulty) {
        const colors = {
            1: "#28a745", // 入门 - 绿色
            2: "#5cb85c", // 基础 - 浅绿色
            3: "#ffc107", // 中级 - 黄色
            4: "#fd7e14", // 高级 - 橙色
            5: "#dc3545"  // 专家 - 红色
        };

        return colors[difficulty] || "#6c757d"; // 默认灰色
    }

    // 显示概念详情
    function showConceptDetails(event, d) {
        // 显示详情容器
        document.getElementById('concept-details-container').style.display = 'block';

        // 获取概念详情
        fetch(`/api/knowledge/concept/${d.id}`)
            .then(response => response.json())
            .then(concept => {
                // 更新界面
                document.getElementById('concept-title').textContent = concept.name;
                document.getElementById('concept-difficulty').textContent = concept.difficulty;
                document.getElementById('concept-difficulty').className = `difficulty-badge difficulty-${concept.difficulty}`;
                document.getElementById('concept-importance').textContent = concept.importance;
                document.getElementById('concept-importance').className = `importance-badge importance-${concept.importance}`;
                document.getElementById('concept-definition').textContent = concept.definition;

                // 更新示例
                const examplesList = document.getElementById('concept-examples-list');
                examplesList.innerHTML = '';

                if (concept.examples && concept.examples.length > 0) {
                    concept.examples.forEach(example => {
                        const exampleDiv = document.createElement('div');
                        exampleDiv.className = 'concept-example';
                        exampleDiv.textContent = example.content;
                        examplesList.appendChild(exampleDiv);
                    });
                } else {
                    const noExampleDiv = document.createElement('div');
                    noExampleDiv.className = 'text-muted';
                    noExampleDiv.textContent = '暂无示例';
                    examplesList.appendChild(noExampleDiv);
                }

                // 更新相关概念
                const relatedList = document.getElementById('related-concepts-list');
                relatedList.innerHTML = '';

                if (concept.related_concepts && concept.related_concepts.length > 0) {
                    concept.related_concepts.forEach(related => {
                        const relatedSpan = document.createElement('span');
                        relatedSpan.className = 'related-concept';
                        relatedSpan.textContent = related;
                        relatedSpan.addEventListener('click', () => {
                            // 点击相关概念时展示该概念详情
                            const relatedNode = graph.nodes.find(n => n.name === related);
                            if (relatedNode) {
                                showConceptDetails(null, relatedNode);
                            }
                        });
                        relatedList.appendChild(relatedSpan);
                    });
                } else {
                    const noRelatedDiv = document.createElement('div');
                    noRelatedDiv.className = 'text-muted';
                    noRelatedDiv.textContent = '暂无相关概念';
                    relatedList.appendChild(noRelatedDiv);
                }
            })
            .catch(error => console.error("获取概念详情失败:", error));
    }

    // 注册事件监听器
    function registerEventListeners() {
        // 领域选择
        document.getElementById('domain-select').addEventListener('change', function() {
            currentDomain = this.value;
            loadKnowledgeGraph();
        });

        // 搜索按钮
        document.getElementById('search-button').addEventListener('click', function() {
            const searchTerm = document.getElementById('concept-search').value.trim();
            if (searchTerm) {
                searchConcept(searchTerm);
            }
        });

        // 回车搜索
        document.getElementById('concept-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.trim();
                if (searchTerm) {
                    searchConcept(searchTerm);
                }
            }
        });

        // 应用筛选
        document.getElementById('apply-filters').addEventListener('click', function() {
            // 获取难度筛选
            filteredDifficulty = [];
            for (let i = 1; i <= 5; i++) {
                if (document.getElementById(`difficulty-${i}`).checked) {
                    filteredDifficulty.push(i);
                }
            }

            // 获取重要性筛选
            filteredImportance = [];
            for (let i = 1; i <= 5; i++) {
                if (document.getElementById(`importance-${i}`).checked) {
                    filteredImportance.push(i);
                }
            }

            // 更新图表
            updateGraph();
        });
    }

    // 搜索概念
    function searchConcept(term) {
        const matchingNodes = graph.nodes.filter(node =>
            node.name.toLowerCase().includes(term.toLowerCase())
        );

        if (matchingNodes.length > 0) {
            // 高亮匹配的节点
            d3.selectAll(".node circle")
                .attr("stroke", d => matchingNodes.some(n => n.id === d.id) ? "#ff0" : "#fff")
                .attr("stroke-width", d => matchingNodes.some(n => n.id === d.id) ? 3 : 1.5);

            // 显示第一个匹配节点的详情
            showConceptDetails(null, matchingNodes[0]);

            // 滚动到该节点
            const node = matchingNodes[0];
            const svg = d3.select("#knowledge-graph svg");
            const width = svg.attr("width");
            const height = svg.attr("height");

            // 计算缩放和平移
            const scale = 2;
            const translate = [width/2 - node.x * scale, height/2 - node.y * scale];

            // 应用变换
            svg.transition()
                .duration(750)
                .call(d3.zoom().transform, d3.zoomIdentity
                    .translate(translate[0], translate[1])
                    .scale(scale));
        } else {
            alert(`未找到匹配"${term}"的概念`);
        }
    }
</script>
{% endblock %}